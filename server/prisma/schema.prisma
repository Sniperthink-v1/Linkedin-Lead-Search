// Prisma schema for LinkedIn Lead Search with Authentication

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User authentication and profile
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String?   // Nullable for OAuth users
  name              String
  emailVerified     Boolean   @default(false)
  verificationToken String?   @unique
  resetToken        String?   @unique
  resetTokenExpiry  DateTime?
  accountStatus     String    @default("active") // active, suspended, deleted
  provider          String    @default("email") // email, google, linkedin
  providerId        String?   // OAuth provider user ID
  credits           Float     @default(100.0) // User credits for API usage
  isAdmin           Boolean   @default(false) // Admin access flag
  createdAt         DateTime  @default(now())
  lastLogin         DateTime?
  
  // Relations
  searches          Search[]
  savedLeads        SavedLead[]
  leadHistory       UserLeadHistory[]
  creditTransactions CreditTransaction[]
  
  @@index([email])
}

// Search history - track every search
model Search {
  id           String   @id @default(uuid())
  userId       String
  searchType   String   // "linkedin" or "business"
  businessType String?  // Job title or business category
  location     String?
  industry     String?
  query        String?  // Natural language query from quick search
  resultCount  Int      @default(0)
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  leads        SavedLead[]
  
  @@index([userId, createdAt])
}

// Saved leads - individual LinkedIn profiles or businesses
model SavedLead {
  id            String   @id @default(uuid())
  userId        String
  searchId      String?
  leadType      String   // "linkedin" or "business"
  
  // LinkedIn profile fields
  personName    String?
  jobTitle      String?
  company       String?
  location      String?
  profileLink   String?
  snippet       String?
  
  // Business fields
  businessName  String?
  address       String?
  phone         String?
  email         String?
  website       String?
  rating        Float?
  totalRatings  String?
  lastReview    String?
  googleMapsLink String?
  ownerName     String?
  description   String?
  category      String?
  searchDate    DateTime?
  
  // Metadata
  savedAt       DateTime @default(now())
  exported      Boolean  @default(false)
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  search        Search?  @relation(fields: [searchId], references: [id], onDelete: Cascade)
  
  @@index([userId, leadType])
  @@index([searchId])
}

// OAuth sessions (optional, for future use)
model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([token])
}

// User lead history - track seen leads to prevent duplicates
model UserLeadHistory {
  id             String   @id @default(uuid())
  userId         String
  leadIdentifier String   // Composite: businessName_city_phone/email
  searchQuery    String?  // Normalized query for analytics
  leadType       String   // "people" or "business"
  createdAt      DateTime @default(now())
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, leadIdentifier])
  @@index([userId, leadIdentifier])
  @@index([createdAt])
}

// City pin codes - scalable storage for location-based searches
model CityPinCode {
  id        String   @id @default(uuid())
  city      String   @unique // City name in lowercase
  pinCodes  String[] // Array of pin codes (6-digit postal codes)
  source    String   @default("static") // "static" or "dynamic" (from Gemini)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([city])
}

// Credit transactions - track all credit usage and additions
model CreditTransaction {
  id              String   @id @default(uuid())
  userId          String
  amount          Float    // Positive for additions, negative for deductions
  type            String   // "search", "purchase", "admin_adjustment", "signup_bonus"
  description     String?
  searchType      String?  // "people" or "business"
  apiCostActual   Float?   // Actual API cost incurred (Serper + Gemini)
  apiCostCharged  Float?   // Amount charged to user (1.25x markup)
  serperCalls     Int?     // Number of Serper API calls
  geminiCalls     Int?     // Number of Gemini API calls
  resultCount     Int?     // Number of results returned
  balanceBefore   Float    // User's balance before transaction
  balanceAfter    Float    // User's balance after transaction
  createdAt       DateTime @default(now())
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, createdAt])
  @@index([type])
}
